# é‚€è¯·ç ç³»ç»Ÿå®æ–½æ€»ç»“

## ğŸ“¦ å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“å±‚é¢ï¼ˆDrizzle ORMï¼‰
**æ–‡ä»¶**: `drizzle/0027_invitation_codes.sql`, `drizzle/schema.ts`

#### æ”¹è¿›ç‚¹ï¼ˆåŸºäº Codex å®‰å…¨å»ºè®®ï¼‰:
- âœ… æ·»åŠ å¤–é”®çº¦æŸï¼ˆ`createdBy`, `codeId`, `userId`ï¼‰ç¡®ä¿æ•°æ®å®Œæ•´æ€§
- âœ… æ·»åŠ å”¯ä¸€çº¦æŸ `UNIQUE(codeId, userId)` é˜²æ­¢é‡å¤ä½¿ç”¨
- âœ… æ·»åŠ  CHECK çº¦æŸç¡®ä¿ `maxUses`, `usedCount`, `grantDays` éè´Ÿ
- âœ… åˆ›å»ºå¤åˆç´¢å¼•ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢ï¼ˆ`isActive + expiresAt`, `createdAt DESC`ï¼‰

#### è¡¨ç»“æ„:
- **invitationCodes**: é‚€è¯·ç ä¸»è¡¨
- **invitationCodeUsage**: ä½¿ç”¨è®°å½•è¡¨
- **users.invitationCodeId**: ç”¨æˆ·å…³è”å­—æ®µ

---

### 2. ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆserver/db.tsï¼‰
**æ–‡ä»¶**: `server/db.ts` (ç¬¬ 2553-2804 è¡Œ)

#### å…³é”®å®‰å…¨æ”¹è¿›:
- âœ… ä½¿ç”¨ **nanoid(12)** ç”ŸæˆåŠ å¯†å®‰å…¨çš„éšæœºé‚€è¯·ç 
- âœ… **æ•°æ®åº“äº‹åŠ¡**ä¿æŠ¤é‚€è¯·ç ä½¿ç”¨æµç¨‹ï¼Œé˜²æ­¢å¹¶å‘ç«æ€
- âœ… **æ¡ä»¶åŸå­æ›´æ–°**é˜²æ­¢è¶…é™ï¼š
  ```typescript
  UPDATE invitationCodes
  SET usedCount = usedCount + 1
  WHERE id = ? AND (maxUses IS NULL OR usedCount < maxUses)
  ```
- âœ… **ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯**é˜²æ­¢æšä¸¾æ”»å‡»ï¼ˆæ‰€æœ‰æ— æ•ˆç è¿”å› "é‚€è¯·ç æ— æ•ˆ"ï¼‰
- âœ… ä¿®å¤ `maxUses` åˆ¤æ–­é€»è¾‘ï¼ˆæ­£ç¡®åŒºåˆ† 0 ä¸ nullï¼‰

#### å®ç°çš„å‡½æ•°:
- `validateInvitationCode(code)`: éªŒè¯é‚€è¯·ç 
- `useInvitationCode(code, userId, ...)`: ä½¿ç”¨é‚€è¯·ç ï¼ˆäº‹åŠ¡ä¿æŠ¤ï¼‰
- `generateInvitationCode(data)`: ç”Ÿæˆé‚€è¯·ç 
- `getAllInvitationCodes()`: è·å–æ‰€æœ‰é‚€è¯·ç ï¼ˆç®¡ç†å‘˜ï¼‰
- `getInvitationCodeUsage(codeId)`: è·å–ä½¿ç”¨è®°å½•
- `toggleInvitationCode(codeId, isActive)`: å¯ç”¨/ç¦ç”¨
- `deleteInvitationCode(codeId)`: åˆ é™¤é‚€è¯·ç 

---

### 3. API è·¯ç”±å±‚ï¼ˆserver/routers.tsï¼‰
**æ–‡ä»¶**: `server/routers.ts` (ç¬¬ 2013-2154 è¡Œ)

#### å®‰å…¨ç‰¹æ€§:
- âœ… **é€Ÿç‡é™åˆ¶**ï¼ˆserver/utils/rateLimit.tsï¼‰:
  - éªŒè¯æ¥å£ï¼š5 æ¬¡/15 åˆ†é’Ÿ/IP
  - æ³¨å†Œæ¥å£ï¼š3 æ¬¡/1 å°æ—¶/IP
- âœ… **æƒé™æ§åˆ¶**ï¼šç®¡ç†å‘˜ä¸“å±è·¯ç”±ï¼ˆlist, generate, usage, toggle, deleteï¼‰
- âœ… **å®¡è®¡æ—¥å¿—**ï¼šæ‰€æœ‰ç®¡ç†æ“ä½œè®°å½•åˆ° auditLogs è¡¨

#### API è·¯ç”±:
- `invitationCodes.validate`: å…¬å¼€éªŒè¯é‚€è¯·ç ï¼ˆå¸¦é€Ÿç‡é™åˆ¶ï¼‰
- `invitationCodes.list`: ç®¡ç†å‘˜è·å–æ‰€æœ‰é‚€è¯·ç 
- `invitationCodes.generate`: ç®¡ç†å‘˜ç”Ÿæˆé‚€è¯·ç 
- `invitationCodes.usage`: ç®¡ç†å‘˜æŸ¥çœ‹ä½¿ç”¨è®°å½•
- `invitationCodes.toggle`: ç®¡ç†å‘˜å¯ç”¨/ç¦ç”¨
- `invitationCodes.delete`: ç®¡ç†å‘˜åˆ é™¤é‚€è¯·ç 

---

### 4. æ³¨å†Œæµç¨‹é›†æˆï¼ˆåç«¯ + å‰ç«¯ï¼‰
**æ–‡ä»¶**: `server/routers.ts` (auth.register), `client/src/pages/Login.tsx`

#### åç«¯æ³¨å†Œæµç¨‹:
1. éªŒè¯é‚€è¯·ç ï¼ˆå¸¦é€Ÿç‡é™åˆ¶ï¼‰
2. ä½¿ç”¨ **Supabase Admin API** åˆ›å»ºç”¨æˆ·ï¼ˆemail_confirm: trueï¼‰
3. åˆ›å»ºæœ¬åœ°ç”¨æˆ·è®°å½•ï¼Œå…³è”è®¢é˜…ç­‰çº§
4. è®°å½•é‚€è¯·ç ä½¿ç”¨ï¼ˆäº‹åŠ¡ä¿æŠ¤ï¼‰
5. è®°å½•å®¡è®¡æ—¥å¿—

#### å‰ç«¯æ”¹è¿›:
- âœ… æ·»åŠ é‚€è¯·ç è¾“å…¥æ¡†ï¼ˆæ³¨å†Œæ¨¡å¼æ˜¾ç¤ºï¼‰
- âœ… å®æ—¶éªŒè¯é‚€è¯·ç ï¼ˆè¾“å…¥â‰¥6å­—ç¬¦æ—¶ï¼‰
- âœ… è§†è§‰åé¦ˆï¼šç»¿è‰²è¾¹æ¡† = æœ‰æ•ˆï¼Œçº¢è‰²è¾¹æ¡† = æ— æ•ˆ
- âœ… è°ƒç”¨åç«¯ `auth.register` API è€Œéç›´æ¥è°ƒç”¨ Supabase
- âœ… æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼

---

### 5. ç®¡ç†åå°ç•Œé¢
**æ–‡ä»¶**: `client/src/pages/InvitationCodes.tsx`

#### åŠŸèƒ½:
- âœ… ç”Ÿæˆé‚€è¯·ç ï¼ˆè‡ªå®šä¹‰æˆ–éšæœºï¼‰
- âœ… è®¾ç½®ä½¿ç”¨é™åˆ¶ï¼ˆæœ€å¤§æ¬¡æ•°ã€æœ‰æ•ˆæœŸã€èµ é€ç­‰çº§ï¼‰
- âœ… æŸ¥çœ‹ä½¿ç”¨æƒ…å†µï¼ˆå·²ç”¨/æ€»æ•°ï¼‰
- âœ… å¯ç”¨/ç¦ç”¨é‚€è¯·ç 
- âœ… åˆ é™¤é‚€è¯·ç 
- âœ… å¤åˆ¶é‚€è¯·ç åˆ°å‰ªè´´æ¿

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§æ€»ç»“

### é˜²æ­¢ Supabase ç»•è¿‡ï¼ˆé«˜å±ï¼‰
- âš ï¸ **å½“å‰çŠ¶æ€**: å‰ç«¯ä»å¯ç›´æ¥è°ƒç”¨ `supabase.auth.signUp()`
- âœ… **åç«¯æ§åˆ¶**: æ–°æ³¨å†Œå¿…é¡»é€šè¿‡ `auth.register` API
- ğŸ”§ **ä¸‹ä¸€æ­¥**: åœ¨ Supabase æ§åˆ¶å°å…³é—­å…¬å¼€æ³¨å†Œ

### é˜²æ­¢å¹¶å‘è¶…é™ï¼ˆé«˜å±ï¼‰
- âœ… æ•°æ®åº“äº‹åŠ¡ + æ¡ä»¶åŸå­æ›´æ–°
- âœ… æ£€æŸ¥å—å½±å“è¡Œæ•°ç¡®ä¿æ›´æ–°æˆåŠŸ

### é˜²æ­¢æš´åŠ›ç ´è§£ï¼ˆä¸­å±ï¼‰
- âœ… nanoid(12) ç”Ÿæˆé«˜ç†µé‚€è¯·ç ï¼ˆçº¦ 62^12 = 3.2e21 ç»„åˆï¼‰
- âœ… é€Ÿç‡é™åˆ¶ï¼šéªŒè¯ 5æ¬¡/15åˆ†é’Ÿï¼Œæ³¨å†Œ 3æ¬¡/1å°æ—¶
- âœ… ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯é˜²æ­¢çŠ¶æ€æšä¸¾

### æ•°æ®å®Œæ•´æ€§ï¼ˆä¸­å±ï¼‰
- âœ… å¤–é”®çº¦æŸ
- âœ… å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤ä½¿ç”¨
- âœ… CHECK çº¦æŸç¡®ä¿éè´Ÿå€¼

---

## ğŸ“‹ å¾…å®Œæˆäº‹é¡¹

### å¿…é¡»å®Œæˆ
1. **é…ç½® Supabase å…³é—­å…¬å¼€æ³¨å†Œ** âš ï¸ é«˜ä¼˜å…ˆçº§
   - è¿›å…¥ Supabase Dashboard â†’ Authentication â†’ Settings
   - å…³é—­ "Enable Email Signup"
   - æˆ–ä½¿ç”¨ Auth Hook/Edge Function å¼ºåˆ¶éªŒè¯é‚€è¯·ç 

### å»ºè®®å®Œæˆ
2. **ç¯å¢ƒå˜é‡é…ç½®**
   - ç¡®ä¿ `.env` åŒ…å« `SUPABASE_SERVICE_ROLE_KEY`ï¼ˆç”¨äº admin æ“ä½œï¼‰

3. **è·¯ç”±é…ç½®**
   - åœ¨è·¯ç”±å™¨ä¸­æ·»åŠ  `/invitation-codes` é¡µé¢ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰

4. **æµ‹è¯•**
   - ç”Ÿæˆé‚€è¯·ç 
   - ä½¿ç”¨é‚€è¯·ç æ³¨å†Œ
   - éªŒè¯é€Ÿç‡é™åˆ¶
   - æµ‹è¯•å¹¶å‘åœºæ™¯

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1: å†…æµ‹é˜¶æ®µ
```typescript
// ç”Ÿæˆ 10 ä¸ªä¸€æ¬¡æ€§é‚€è¯·ç ï¼Œèµ é€ 30 å¤© Pro
for (let i = 0; i < 10; i++) {
  await db.generateInvitationCode({
    description: 'å†…æµ‹ç”¨æˆ·ä¸“å±',
    createdBy: adminId,
    maxUses: 1,
    expiresAt: new Date('2025-03-31'),
    grantTier: 'pro',
    grantDays: 30,
  });
}
```

### åœºæ™¯ 2: æ¨å¹¿æ´»åŠ¨
```typescript
// ç”Ÿæˆå…¬å¼€ç ï¼Œ100 æ¬¡ä½¿ç”¨ï¼Œ7 å¤©è¿‡æœŸ
await db.generateInvitationCode({
  code: 'LAUNCH2025',
  description: 'äº§å“å‘å¸ƒæ´»åŠ¨',
  createdBy: adminId,
  maxUses: 100,
  expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
  grantTier: 'basic',
  grantDays: 90,
});
```

---

## ğŸ” ä»£ç ä½ç½®ç´¢å¼•

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| æ•°æ®åº“è¿ç§» | `drizzle/0027_invitation_codes.sql` | å…¨æ–‡ |
| Schema å®šä¹‰ | `drizzle/schema.ts` | 500-546 |
| ä¸šåŠ¡é€»è¾‘ | `server/db.ts` | 2553-2804 |
| API è·¯ç”± | `server/routers.ts` | 2013-2154 |
| æ³¨å†Œ API | `server/routers.ts` | 32-144 |
| Supabase Admin | `server/lib/supabase.ts` | å…¨æ–‡ |
| é€Ÿç‡é™åˆ¶ | `server/utils/rateLimit.ts` | å…¨æ–‡ |
| å‰ç«¯æ³¨å†Œ | `client/src/pages/Login.tsx` | å…¨æ–‡ |
| ç®¡ç†ç•Œé¢ | `client/src/pages/InvitationCodes.tsx` | å…¨æ–‡ |

---

## ğŸ“Š æ¶æ„å†³ç­–è®°å½•

### ADR-001: ä¸ºä»€ä¹ˆä½¿ç”¨åç«¯æ³¨å†Œ API è€Œéå‰ç«¯ç›´æ¥è°ƒç”¨ Supabaseï¼Ÿ
**å†³ç­–**: åœ¨åç«¯å®ç° `auth.register` APIï¼Œé›†ä¸­éªŒè¯é‚€è¯·ç 

**ç†ç”±**:
1. **å®‰å…¨**: é˜²æ­¢ç”¨æˆ·ç»•è¿‡å‰ç«¯ç›´æ¥è°ƒç”¨ Supabase API
2. **æ§åˆ¶**: åç«¯å®Œå…¨æŒæ§æ³¨å†Œæµç¨‹ï¼ˆéªŒè¯ã€åˆ›å»ºã€è®°å½•ï¼‰
3. **åŸå­æ€§**: ä½¿ç”¨äº‹åŠ¡ç¡®ä¿é‚€è¯·ç ä½¿ç”¨ä¸ç”¨æˆ·åˆ›å»ºçš„ä¸€è‡´æ€§
4. **å®¡è®¡**: ç»Ÿä¸€è®°å½•æ‰€æœ‰æ³¨å†Œäº‹ä»¶

**æ›¿ä»£æ–¹æ¡ˆ**:
- æ–¹æ¡ˆ Aï¼ˆå½“å‰ï¼‰: åç«¯ API + Supabase Admin âœ…
- æ–¹æ¡ˆ B: Supabase Auth Hookï¼ˆéœ€è¦ Pro è®¡åˆ’ï¼‰âŒ
- æ–¹æ¡ˆ C: å‰ç«¯éªŒè¯ + Supabase signUpï¼ˆä¸å®‰å…¨ï¼‰âŒ

---

## âœ… Codex å®‰å…¨å®¡æŸ¥å»ºè®®å®æ–½æ¸…å•

- [x] ä½¿ç”¨ nanoid æ›¿ä»£ Math.random
- [x] å®ç°æ•°æ®åº“äº‹åŠ¡é˜²æ­¢ç«æ€
- [x] æ¡ä»¶åŸå­æ›´æ–°é˜²æ­¢è¶…é™
- [x] æ·»åŠ å¤–é”®å’Œå”¯ä¸€çº¦æŸ
- [x] å®ç°é€Ÿç‡é™åˆ¶
- [x] ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯é˜²æ­¢æšä¸¾
- [x] æ·»åŠ å¤åˆç´¢å¼•ä¼˜åŒ–æ€§èƒ½
- [x] ä¿®å¤ maxUses åˆ¤æ–­é€»è¾‘
- [ ] é…ç½® Supabase å…³é—­å…¬å¼€æ³¨å†Œï¼ˆå¾…ç”¨æˆ·æ“ä½œï¼‰

---

**å®æ–½æ—¶é—´**: 2025-12-31
**å®¡æŸ¥è€…**: Codex (gpt-5.1-codex-max)
**å®æ–½è€…**: Claude Sonnet 4.5
